<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#667eea">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <link rel="manifest" href="manifest.json">
    <title>Reporte de Grupo</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1 id="headerTitle">üìç Reporte de Grupo</h1>
            <div class="user-info">
                <span class="user-name" id="userName"></span>
                <button class="btn-logout" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div class="content">
            <!-- Informaci√≥n del Grupo -->
            <div class="group-header">
                <div class="group-logo">
                    <img id="grupoLogo" src="" alt="Logo" class="group-logo-img">
                </div>
                <div class="group-info">
                    <h2 id="grupoTitulo"></h2>
                    <div class="leader-info">
                        <h3 id="liderIcon">üë®‚Äçüíº L√≠der del Grupo</h3>
                        <p class="leader-name" id="liderNombre"></p>
                    </div>
                </div>
            </div>

            <!-- Equipo de Auxiliares -->
            <div class="section">
                <h3 class="section-title">üë• Equipo de Auxiliares</h3>
                <div class="auxiliares-grid" id="auxiliaresGrid">
                    <!-- Se llenar√° din√°micamente -->
                </div>
                <div class="team-summary">
                    <p><strong>Total de Auxiliares:</strong> <span id="totalAuxiliares">0</span> miembros</p>
                </div>
            </div>

            <!-- Secci√≥n de Reportes -->
            <div class="section">
                <h3 class="section-title">üìä Reportes y Actividades</h3>
                <div class="reports-container">
                    <div class="report-actions">
                        <button class="btn-action" onclick="toggleFormularioReporte()">
                            <span class="btn-icon">‚ûï</span>
                            Crear Nuevo Reporte
                        </button>
                        <button class="btn-action secondary" onclick="verEstadisticas()">
                            <span class="btn-icon">üìà</span>
                            Ver Estad√≠sticas
                        </button>
                        <button class="btn-action secondary" onclick="verHistorial()">
                            <span class="btn-icon">üìã</span>
                            Historial de Reportes
                        </button>
                    </div>

                    <!-- Formulario de Nuevo Reporte (oculto inicialmente) -->
                    <div id="formularioReporte" class="formulario-reporte" style="display: none;">
                        <h4>üìù Nuevo Reporte de Actividad</h4>
                        <form id="formReporte" onsubmit="return guardarReporte(event)">
                            
                            <!-- Informaci√≥n General -->
                            <div class="seccion-formulario">
                                <h5>üìã Informaci√≥n General</h5>
                                <div class="form-row">
                                    <div class="form-field">
                                        <label>Fecha</label>
                                        <input type="date" id="fechaActividad" required readonly style="background: #f8f9fa;">
                                    </div>
                                    <div class="form-field">
                                        <label>L√≠der del Grupo</label>
                                        <input type="text" id="liderGrupo" readonly style="background: #f8f9fa; font-weight: 600;">
                                    </div>
                                    <div class="form-field">
                                        <label>Tipo de Actividad</label>
                                        <select id="tipoActividad" required>
                                            <option value="">Seleccionar...</option>
                                            <option value="Culto Regular">Culto Regular</option>
                                            <option value="Evangelismo">Evangelismo</option>
                                            <option value="Visitaci√≥n">Visitaci√≥n</option>
                                            <option value="Estudio B√≠blico">Estudio B√≠blico</option>
                                            <option value="Reuni√≥n de Oraci√≥n">Reuni√≥n de Oraci√≥n</option>
                                            <option value="Actividad Especial">Actividad Especial</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Conteo de Asistencia -->
                            <div class="seccion-formulario">
                                <h5>üë• Conteo de Asistencia Filial</h5>
                                <div class="form-row">
                                    <div class="form-field">
                                        <label>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Cantidad de Adultos</label>
                                        <input type="number" id="cantidadAdultos" min="0" value="0" required>
                                    </div>
                                    <div class="form-field">
                                        <label>üë∂ Cantidad de Ni√±os</label>
                                        <input type="number" id="cantidadNinos" min="0" value="0" required>
                                    </div>
                                    <div class="form-field">
                                        <label><strong>üìä Total Asistentes</strong></label>
                                        <input type="number" id="totalAsistentes" readonly style="background: #e8f5e9; font-weight: bold; font-size: 18px; color: #28a745;">
                                    </div>
                                </div>
                            </div>

                            <!-- Tabla de Asistencia del Equipo -->
                            <div class="seccion-formulario">
                                <h5>‚úÖ Asistencia del Equipo de Auxiliares</h5>
                                <div class="tabla-asistencia-wrapper">
                                    <table class="tabla-asistencia">
                                        <thead>
                                            <tr>
                                                <th>Auxiliar</th>
                                                <th>Asisti√≥</th>
                                                <th>No Asisti√≥</th>
                                                <th>Permiso</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablaAsistenciaBody">
                                            <!-- Se llenar√° din√°micamente -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Resumen de Asistencia -->
                                <div id="resumenAsistencia" class="resumen-asistencia" style="display: none;">
                                    <div class="resumen-grupo">
                                        <h6 style="color: #28a745; margin-bottom: 10px;">‚úÖ Asistieron (<span id="countAsistieron">0</span>)</h6>
                                        <ul id="listaAsistieron" class="lista-resumen"></ul>
                                    </div>
                                    <div class="resumen-grupo">
                                        <h6 style="color: #dc3545; margin-bottom: 10px;">‚ùå No Asistieron (<span id="countNoAsistieron">0</span>)</h6>
                                        <ul id="listaNoAsistieron" class="lista-resumen"></ul>
                                    </div>
                                    <div class="resumen-grupo">
                                        <h6 style="color: #ffc107; margin-bottom: 10px;">üìù Con Permiso (<span id="countPermiso">0</span>)</h6>
                                        <ul id="listaPermiso" class="lista-resumen"></ul>
                                    </div>
                                </div>
                            </div>

                            <!-- Observaciones -->
                            <div class="seccion-formulario">
                                <h5>üìù Observaciones</h5>
                                <div class="form-field">
                                    <textarea id="observaciones" rows="4" placeholder="Detalles adicionales de la actividad, testimonios, novedades..."></textarea>
                                </div>
                            </div>

                            <!-- Actividades y Visitas -->
                            <div class="seccion-formulario">
                                <h5>üìÖ Actividades y Ministerio</h5>
                                <div class="form-field">
                                    <label>‚úÖ Actividad Realizada</label>
                                    <textarea id="actividadRealizada" rows="3" placeholder="Describa la actividad que se realiz√≥ durante esta reuni√≥n o evento..."></textarea>
                                </div>
                                <div class="form-field">
                                    <label>üìÜ Actividad Programada</label>
                                    <textarea id="actividadProgramada" rows="3" placeholder="Describa las pr√≥ximas actividades planificadas para el grupo..."></textarea>
                                </div>
                            </div>

                            <!-- Visitas y Seguimiento -->
                            <div class="seccion-formulario">
                                <h5>üè† Visitas y Seguimiento Pastoral</h5>
                                <div class="form-field">
                                    <label>üë• Visitas Realizadas a Hermanos</label>
                                    <textarea id="visitasRealizadas" rows="3" placeholder="Registre las visitas realizadas a los hermanos en sus hogares (nombre, motivo, fecha)..."></textarea>
                                </div>
                                <div class="form-field">
                                    <label>üè• Reporte de Hermanos Enfermos</label>
                                    <textarea id="hermanosEnfermos" rows="3" placeholder="Liste los hermanos que requieren oraci√≥n por enfermedad o necesidad especial..."></textarea>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn-guardar">üíæ Guardar Reporte</button>
                                <button type="button" class="btn-cancelar" onclick="toggleFormularioReporte()">‚ùå Cancelar</button>
                            </div>
                        </form>
                    </div>

                    <!-- Tabla de reportes recientes -->
                    <div class="reports-table-container">
                        <h4>Reportes Recientes</h4>
                        <table class="reports-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo de Actividad</th>
                                    <th>Adultos</th>
                                    <th>Ni√±os</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaReportes">
                                <tr class="no-data">
                                    <td colspan="7">
                                        <p style="text-align: center; padding: 30px; color: #999;">
                                            No hay reportes registrados a√∫n.<br>
                                            <small>Haz clic en "Crear Nuevo Reporte" para comenzar.</small>
                                        </p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Bot√≥n de regreso -->
            <div style="margin-top: 30px; text-align: center;">
                <button class="btn-back" onclick="volverAtras()">
                    ‚Üê Volver
                </button>
            </div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script src="grupos-data.js"></script>
    <script>
        if (!verificarSesion()) {
            window.location.href = 'index.html';
        }
        
        const usuario = obtenerUsuarioActual();
        document.getElementById('userName').textContent = usuario.nombre;

        // Obtener la filial seleccionada (a d√≥nde va el grupo)
        const misionSeleccionada = sessionStorage.getItem('misionSeleccionada');
        
        // Obtener el grupo del l√≠der (su grupo misionero)
        const grupoDelLider = usuario.grupoAsignado;
        
        // Si no hay misi√≥n seleccionada, usar el grupo del l√≠der por defecto
        const grupoAsignado = grupoDelLider;
        
        const datosGrupo = GRUPOS_DATA[grupoAsignado];
        
        // Obtener datos de la filial seleccionada
        let datosFilial = datosGrupo; // Por defecto usar los datos del grupo
        if (misionSeleccionada && GRUPOS_DATA[misionSeleccionada]) {
            datosFilial = GRUPOS_DATA[misionSeleccionada];
        }

        if (datosGrupo) {
            // Mostrar la filial (mision) que est√°n visitando
            document.getElementById('headerTitle').innerHTML = datosFilial.emoji + ' ' + datosFilial.mision;
            document.getElementById('grupoTitulo').textContent = datosFilial.mision;
            document.getElementById('grupoLogo').src = datosFilial.logo;
            document.getElementById('liderIcon').innerHTML = datosGrupo.liderIcono + ' L√≠der del ' + datosGrupo.nombre;
            document.getElementById('liderNombre').textContent = datosGrupo.lider;

            const auxiliaresGrid = document.getElementById('auxiliaresGrid');
            auxiliaresGrid.innerHTML = '';
            
            datosGrupo.auxiliares.forEach(auxiliar => {
                const card = document.createElement('div');
                card.className = 'auxiliar-card';
                card.innerHTML = `
                    <div class="auxiliar-icon">${auxiliar.icono}</div>
                    <p class="auxiliar-name">${auxiliar.nombre}</p>
                `;
                auxiliaresGrid.appendChild(card);
            });

            document.getElementById('totalAuxiliares').textContent = datosGrupo.auxiliares.length;
        }

        document.getElementById('cantidadAdultos').addEventListener('input', calcularTotal);
        document.getElementById('cantidadNinos').addEventListener('input', calcularTotal);

        function calcularTotal() {
            const adultos = parseInt(document.getElementById('cantidadAdultos').value) || 0;
            const ninos = parseInt(document.getElementById('cantidadNinos').value) || 0;
            document.getElementById('totalAsistentes').value = adultos + ninos;
        }

        function cargarListaAsistencia() {
            const tablaBody = document.getElementById('tablaAsistenciaBody');
            tablaBody.innerHTML = '';

            // Agregar fila del l√≠der primero
            const rowLider = document.createElement('tr');
            rowLider.innerHTML = `
                <td class="nombre-auxiliar" style="font-weight: bold; background: #fff3cd;">${datosGrupo.liderIcono} ${datosGrupo.lider} (L√≠der)</td>
                <td class="td-radio">
                    <label class="radio-label">
                        <input type="radio" name="asistencia_lider" value="asistio" checked onchange="actualizarResumen()">
                    </label>
                </td>
                <td class="td-radio">
                    <label class="radio-label">
                        <input type="radio" name="asistencia_lider" value="falta" onchange="actualizarResumen()">
                    </label>
                </td>
                <td class="td-radio">
                    <label class="radio-label">
                        <input type="radio" name="asistencia_lider" value="permiso" onchange="actualizarResumen()">
                    </label>
                </td>
            `;
            tablaBody.appendChild(rowLider);

            // Agregar auxiliares
            datosGrupo.auxiliares.forEach((auxiliar, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="nombre-auxiliar">${auxiliar.icono} ${auxiliar.nombre}</td>
                    <td class="td-radio">
                        <label class="radio-label">
                            <input type="radio" name="asistencia_${index}" value="asistio" checked onchange="actualizarResumen()">
                        </label>
                    </td>
                    <td class="td-radio">
                        <label class="radio-label">
                            <input type="radio" name="asistencia_${index}" value="falta" onchange="actualizarResumen()">
                        </label>
                    </td>
                    <td class="td-radio">
                        <label class="radio-label">
                            <input type="radio" name="asistencia_${index}" value="permiso" onchange="actualizarResumen()">
                        </label>
                    </td>
                `;
                tablaBody.appendChild(row);
            });
        }

        function actualizarResumen() {
            const resumenDiv = document.getElementById('resumenAsistencia');
            resumenDiv.style.display = 'block';

            const asistieron = [];
            const noAsistieron = [];
            const conPermiso = [];

            // Verificar l√≠der
            const asistenciaLider = document.querySelector('input[name="asistencia_lider"]:checked')?.value;
            const nombreLider = `${datosGrupo.liderIcono} ${datosGrupo.lider} (L√≠der)`;
            
            if (asistenciaLider === 'asistio') asistieron.push(nombreLider);
            else if (asistenciaLider === 'falta') noAsistieron.push(nombreLider);
            else if (asistenciaLider === 'permiso') conPermiso.push(nombreLider);

            // Verificar auxiliares
            datosGrupo.auxiliares.forEach((auxiliar, index) => {
                const seleccion = document.querySelector(`input[name="asistencia_${index}"]:checked`)?.value;
                const nombreCompleto = `${auxiliar.icono} ${auxiliar.nombre}`;
                
                if (seleccion === 'asistio') asistieron.push(nombreCompleto);
                else if (seleccion === 'falta') noAsistieron.push(nombreCompleto);
                else if (seleccion === 'permiso') conPermiso.push(nombreCompleto);
            });

            // Actualizar listas
            document.getElementById('countAsistieron').textContent = asistieron.length;
            document.getElementById('listaAsistieron').innerHTML = asistieron.map(n => `<li>${n}</li>`).join('');
            
            document.getElementById('countNoAsistieron').textContent = noAsistieron.length;
            document.getElementById('listaNoAsistieron').innerHTML = noAsistieron.length > 0 ? noAsistieron.map(n => `<li>${n}</li>`).join('') : '<li style="color: #999;">Ninguno</li>';
            
            document.getElementById('countPermiso').textContent = conPermiso.length;
            document.getElementById('listaPermiso').innerHTML = conPermiso.length > 0 ? conPermiso.map(n => `<li>${n}</li>`).join('') : '<li style="color: #999;">Ninguno</li>';
        }

        function toggleFormularioReporte() {
            const formulario = document.getElementById('formularioReporte');
            if (formulario.style.display === 'none') {
                formulario.style.display = 'block';
                
                const hoy = new Date();
                const fechaFormateada = hoy.toISOString().split('T')[0];
                document.getElementById('fechaActividad').value = fechaFormateada;
                document.getElementById('liderGrupo').value = datosGrupo.lider;
                
                calcularTotal();
                cargarListaAsistencia();
                actualizarResumen();
            } else {
                formulario.style.display = 'none';
                document.getElementById('formReporte').reset();
                document.getElementById('resumenAsistencia').style.display = 'none';
            }
        }

        function guardarReporte(event) {
            event.preventDefault();

            const fecha = document.getElementById('fechaActividad').value;
            const tipo = document.getElementById('tipoActividad').value;
            const adultos = document.getElementById('cantidadAdultos').value;
            const ninos = document.getElementById('cantidadNinos').value;
            const total = document.getElementById('totalAsistentes').value;
            const observaciones = document.getElementById('observaciones').value;
            const actividadRealizada = document.getElementById('actividadRealizada').value;
            const actividadProgramada = document.getElementById('actividadProgramada').value;
            const visitasRealizadas = document.getElementById('visitasRealizadas').value;
            const hermanosEnfermos = document.getElementById('hermanosEnfermos').value;

            const asistencia = {};
            
            // Guardar asistencia del l√≠der
            const asistenciaLider = document.querySelector('input[name="asistencia_lider"]:checked');
            asistencia[datosGrupo.lider + ' (L√≠der)'] = asistenciaLider ? asistenciaLider.value : 'asistio';
            
            // Guardar asistencia de auxiliares
            datosGrupo.auxiliares.forEach((auxiliar, index) => {
                const seleccion = document.querySelector(`input[name="asistencia_${index}"]:checked`);
                asistencia[auxiliar.nombre] = seleccion ? seleccion.value : 'asistio';
            });

            const reporte = {
                fecha,
                tipo,
                adultos,
                ninos,
                total,
                observaciones,
                actividadRealizada,
                actividadProgramada,
                visitasRealizadas,
                hermanosEnfermos,
                asistencia,
                grupo: datosGrupo.nombre,
                mision: datosFilial.mision,  // La filial visitada, no la del grupo
                lider: datosGrupo.lider,
                fechaCreacion: new Date().toISOString()
            };

            let reportes = JSON.parse(localStorage.getItem('reportes') || '[]');
            reportes.unshift(reporte);
            localStorage.setItem('reportes', JSON.stringify(reportes));

            alert('‚úÖ Reporte guardado exitosamente!\n\nFecha: ' + fecha + '\nTipo: ' + tipo + '\nTotal Asistentes: ' + total);

            toggleFormularioReporte();
            cargarReportes();
        }

        function cargarReportes() {
            const reportes = JSON.parse(localStorage.getItem('reportes') || '[]');
            const tbody = document.getElementById('tablaReportes');
            
            const reportesGrupo = reportes.filter(r => 
                r.grupo === datosGrupo.nombre && r.mision === datosGrupo.mision
            );

            if (reportesGrupo.length === 0) {
                tbody.innerHTML = `
                    <tr class="no-data">
                        <td colspan="7">
                            <p style="text-align: center; padding: 30px; color: #999;">
                                No hay reportes registrados a√∫n.<br>
                                <small>Haz clic en "Crear Nuevo Reporte" para comenzar.</small>
                            </p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = '';
            reportesGrupo.slice(0, 10).forEach((reporte, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${reporte.fecha}</td>
                    <td>${reporte.tipo}</td>
                    <td>${reporte.adultos}</td>
                    <td>${reporte.ninos}</td>
                    <td><strong>${reporte.total}</strong></td>
                    <td><span class="badge-activo">Registrado</span></td>
                    <td>
                        <button class="btn-small" onclick="verDetalleReporte(${index})">üëÅÔ∏è Ver</button>
                        <button class="btn-small danger" onclick="eliminarReporte(${index})">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function verDetalleReporte(index) {
            const reportes = JSON.parse(localStorage.getItem('reportes') || '[]');
            const reportesGrupo = reportes.filter(r => 
                r.grupo === datosGrupo.nombre && r.mision === datosGrupo.mision
            );
            const reporte = reportesGrupo[index];

            let asistenciaTexto = '\n\nüìã ASISTENCIA DE AUXILIARES:\n';
            for (const [nombre, estado] of Object.entries(reporte.asistencia)) {
                const emoji = estado === 'asistio' ? '‚úÖ' : estado === 'permiso' ? 'üìù' : '‚ùå';
                asistenciaTexto += `${emoji} ${nombre}\n`;
            }

            alert(`üìä DETALLE DEL REPORTE\n\n` +
                  `Fecha: ${reporte.fecha}\n` +
                  `Tipo: ${reporte.tipo}\n` +
                  `Adultos: ${reporte.adultos}\n` +
                  `Ni√±os: ${reporte.ninos}\n` +
                  `Total: ${reporte.total}\n\n` +
                  `üìù Observaciones: ${reporte.observaciones || 'Sin observaciones'}\n\n` +
                  `‚úÖ Actividad Realizada: ${reporte.actividadRealizada || 'No especificada'}\n\n` +
                  `üìÜ Actividad Programada: ${reporte.actividadProgramada || 'No especificada'}\n\n` +
                  `üè† Visitas Realizadas: ${reporte.visitasRealizadas || 'No registradas'}\n\n` +
                  `üè• Hermanos Enfermos: ${reporte.hermanosEnfermos || 'No registrados'}` +
                  asistenciaTexto);
        }

        function eliminarReporte(index) {
            if (!confirm('¬øEst√°s seguro de eliminar este reporte?')) return;

            const reportes = JSON.parse(localStorage.getItem('reportes') || '[]');
            const reportesGrupo = reportes.filter(r => 
                r.grupo === datosGrupo.nombre && r.mision === datosGrupo.mision
            );
            const reporteAEliminar = reportesGrupo[index];

            const todosReportes = JSON.parse(localStorage.getItem('reportes') || '[]');
            const indexGlobal = todosReportes.findIndex(r => 
                r.fechaCreacion === reporteAEliminar.fechaCreacion
            );

            if (indexGlobal > -1) {
                todosReportes.splice(indexGlobal, 1);
                localStorage.setItem('reportes', JSON.stringify(todosReportes));
                cargarReportes();
                alert('‚úÖ Reporte eliminado');
            }
        }

        function volverAtras() {
            if (usuario.rol === 'administrador') {
                window.location.href = 'dashboard-admin.html';
            } else {
                window.location.href = 'reportes-misiones.html';
            }
        }

        function verEstadisticas() {
            const reportes = JSON.parse(localStorage.getItem('reportes') || '[]');
            const reportesGrupo = reportes.filter(r => 
                r.grupo === datosGrupo.nombre && r.mision === datosGrupo.mision
            );

            const totalReportes = reportesGrupo.length;
            const totalAsistentes = reportesGrupo.reduce((sum, r) => sum + parseInt(r.total), 0);
            const promedio = totalReportes > 0 ? Math.round(totalAsistentes / totalReportes) : 0;

            alert(`üìà ESTAD√çSTICAS - ${datosGrupo.nombre}\n\n` +
                  `Total de Reportes: ${totalReportes}\n` +
                  `Total de Asistentes (acumulado): ${totalAsistentes}\n` +
                  `Promedio de Asistencia: ${promedio} personas\n\n` +
                  `üìä Pr√≥ximamente: Gr√°ficas detalladas`);
        }

        function verHistorial() {
            alert('üìã Historial completo de reportes\n\nPr√≥ximamente podr√°s:\n‚Ä¢ Filtrar por fecha\n‚Ä¢ Buscar por tipo de actividad\n‚Ä¢ Exportar reportes\n‚Ä¢ Ver tendencias');
        }

        cargarReportes();
    </script>
</body>
</html>
