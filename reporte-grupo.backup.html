<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Grupo</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1 id="headerTitle">üìç Reporte de Grupo</h1>
            <div class="user-info">
                <span class="user-name" id="userName"></span>
                <button class="btn-logout" onclick="cerrarSesion()">Cerrar Sesi√≥n</button>
            </div>
        </div>

        <div class="content">
            <!-- Informaci√≥n del Grupo -->
            <div class="group-header">
                <div class="group-logo">
                    <img id="grupoLogo" src="" alt="Logo" class="group-logo-img">
                </div>
                <div class="group-info">
                    <h2 id="grupoTitulo"></h2>
                    <div class="leader-info">
                        <h3 id="liderIcon">üë®‚Äçüíº L√≠der del Grupo</h3>
                        <p class="leader-name" id="liderNombre"></p>
                    </div>
                </div>
            </div>

            <!-- Equipo de Auxiliares -->
            <div class="section">
                <h3 class="section-title">üë• Equipo de Auxiliares</h3>
                <div class="auxiliares-grid" id="auxiliaresGrid">
                    <!-- Se llenar√° din√°micamente -->
                </div>
                <div class="team-summary">
                    <p><strong>Total de Auxiliares:</strong> <span id="totalAuxiliares">0</span> miembros</p>
                </div>
            </div>

            <!-- Secci√≥n de Reportes -->
            <div class="section">
                <h3 class="section-title">üìä Reportes y Actividades</h3>
                <div class="reports-container">
                    <div class="report-actions">
                        <button class="btn-action" onclick="toggleFormularioReporte()">
                            <span class="btn-icon">‚ûï</span>
                            Crear Nuevo Reporte
                        </button>
                        <button class="btn-action secondary" onclick="verEstadisticas()">
                            <span class="btn-icon">üìà</span>
                            Ver Estad√≠sticas
                        </button>
                        <button class="btn-action secondary" onclick="verHistorial()">
                            <span class="btn-icon">üìã</span>
                            Historial de Reportes
                        </button>
                    </div>

                    <!-- Formulario de Nuevo Reporte (oculto inicialmente) -->
                    <div id="formularioReporte" class="formulario-reporte" style="display: none;">
                        <h4>üìù Nuevo Reporte de Actividad</h4>
                        <form id="formReporte" onsubmit="return guardarReporte(event)">
                            
                            <!-- Informaci√≥n General -->
                            <div class="seccion-formulario">
                                <h5>üìã Informaci√≥n General</h5>
                                <div class="form-row">
                                    <div class="form-field">
                                        <label>Fecha</label>
                                        <input type="date" id="fechaActividad" required readonly style="background: #f8f9fa;">
                                    </div>
                                    <div class="form-field">
                                        <label>L√≠der del Grupo</label>
                                        <input type="text" id="liderGrupo" readonly style="background: #f8f9fa; font-weight: 600;">
                                    </div>
                                    <div class="form-field">
                                        <label>Tipo de Actividad</label>
                                        <select id="tipoActividad" required>
                                            <option value="">Seleccionar...</option>
                                            <option value="Culto Regular">Culto Regular</option>
                                            <option value="Evangelismo">Evangelismo</option>
                                            <option value="Visitaci√≥n">Visitaci√≥n</option>
                                            <option value="Estudio B√≠blico">Estudio B√≠blico</option>
                                            <option value="Reuni√≥n de Oraci√≥n">Reuni√≥n de Oraci√≥n</option>
                                            <option value="Actividad Especial">Actividad Especial</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Conteo de Asistencia -->
                            <div class="seccion-formulario">
                                <h5>üë• Conteo de Asistencia General</h5>
                                <div class="form-row">
                                    <div class="form-field">
                                        <label>üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Cantidad de Adultos</label>
                                        <input type="number" id="cantidadAdultos" min="0" value="0" required>
                                    </div>
                                    <div class="form-field">
                                        <label>üë∂ Cantidad de Ni√±os</label>
                                        <input type="number" id="cantidadNinos" min="0" value="0" required>
                                    </div>
                                    <div class="form-field">
                                        <label><strong>üìä Total Asistentes</strong></label>
                                        <input type="number" id="totalAsistentes" readonly style="background: #e8f5e9; font-weight: bold; font-size: 18px; color: #28a745;">
                                    </div>
                                </div>
                            </div>

                            <!-- Tabla de Asistencia del Equipo -->
                            <div class="seccion-formulario">
                                <h5>‚úÖ Asistencia del Equipo de Auxiliares</h5>
                                <div class="tabla-asistencia-wrapper">
                                    <table class="tabla-asistencia">
                                        <thead>
                                            <tr>
                                                <th>Auxiliar</th>
                                                <th>Asisti√≥</th>
                                                <th>No Asisti√≥</th>
                                                <th>Permiso</th>
                                            </tr>
                                        </thead>
                                        <tbody id="tablaAsistenciaBody">
                                            <!-- Se llenar√° din√°micamente -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Observaciones -->
                            <div class="seccion-formulario">
                                <h5>üìù Observaciones</h5>
                                <div class="form-field">
                                    <textarea id="observaciones" rows="4" placeholder="Detalles adicionales de la actividad, testimonios, novedades..."></textarea>
                                </div>
                            </div>

                            <div class="form-actions">
                                <button type="submit" class="btn-guardar">üíæ Guardar Reporte</button>
                                <button type="button" class="btn-cancelar" onclick="toggleFormularioReporte()">‚ùå Cancelar</button>
                            </div>
                        </form>
                    </div>

                    <!-- Tabla de reportes recientes -->
                    <div class="reports-table-container">
                        <h4>Reportes Recientes</h4>
                        <table class="reports-table">
                            <thead>
                                <tr>
                                    <th>Fecha</th>
                                    <th>Tipo de Actividad</th>
                                    <th>Adultos</th>
                                    <th>Ni√±os</th>
                                    <th>Total</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="tablaReportes">
                                <tr class="no-data">
                                    <td colspan="7">
                                        <p style="text-align: center; padding: 30px; color: #999;">
                                            No hay reportes registrados a√∫n.<br>
                                            <small>Haz clic en "Crear Nuevo Reporte" para comenzar.</small>
                                        </p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Bot√≥n de regreso -->
            <div style="margin-top: 30px; text-align: center;">
                <button class="btn-back" onclick="volverAtras()">
                    ‚Üê Volver
                </button>
            </div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script src="grupos-data.js"></script>
    <script>
        // Verificar sesi√≥n al cargar la p√°gina
        if (!verificarSesion()) {
            window.location.href = 'index.html';
        }
        
        // Mostrar nombre del usuario
        const usuario = obtenerUsuarioActual();
        document.getElementById('userName').textContent = usuario.nombre;

        // Cargar datos del grupo seg√∫n el usuario
        const grupoAsignado = usuario.grupoAsignado;
        const datosGrupo = GRUPOS_DATA[grupoAsignado];

        if (datosGrupo) {
            // Actualizar t√≠tulo y logo
            document.getElementById('headerTitle').innerHTML = datosGrupo.emoji + ' ' + datosGrupo.mision + ' - ' + datosGrupo.nombre;
            document.getElementById('grupoTitulo').textContent = datosGrupo.nombre + ' - ' + datosGrupo.mision;
            document.getElementById('grupoLogo').src = datosGrupo.logo;
            document.getElementById('liderIcon').innerHTML = datosGrupo.liderIcono + ' L√≠der del Grupo';
            document.getElementById('liderNombre').textContent = datosGrupo.lider;

            // Cargar auxiliares
            const auxiliaresGrid = document.getElementById('auxiliaresGrid');
            auxiliaresGrid.innerHTML = '';
            
            datosGrupo.auxiliares.forEach(auxiliar => {
                const card = document.createElement('div');
                card.className = 'auxiliar-card';
                card.innerHTML = `
                    <div class="auxiliar-icon">${auxiliar.icono}</div>
                    <p class="auxiliar-name">${auxiliar.nombre}</p>
                `;
                auxiliaresGrid.appendChild(card);
            });

            document.getElementById('totalAuxiliares').textContent = datosGrupo.auxiliares.length;

            // Cargar lista de asistencia
            cargarListaAsistencia();
        }

        // Calcular total autom√°ticamente
        document.getElementById('cantidadAdultos').addEventListener('input', calcularTotal);
        document.getElementById('cantidadNinos').addEventListener('input', calcularTotal);

        function calcularTotal() {
            const adultos = parseInt(document.getElementById('cantidadAdultos').value) || 0;
            const ninos = parseInt(document.getElementById('cantidadNinos').value) || 0;
            documverEstadisticas() {
            const reportes = JSON.parse(localStorage.getItem('reportes') || '[]');
            const reportesGrupo = reportes.filter(r => 
                r.grupo === datosGrupo.nombre && r.mision === datosGrupo.mision
            );

            const totalReportes = reportesGrupo.length;
            const totalAsistentes = reportesGrupo.reduce((sum, r) => sum + parseInt(r.total), 0);
            const promedio = totalReportes > 0 ? Math.round(totalAsistentes / totalReportes) : 0;

            alert(`üìà ESTAD√çSTICAS - ${datosGrupo.nombre}\n\n` +
                  `Total de Reportes: ${totalReportes}\n` +
                  `Total de Asistentes (acumulado): ${totalAsistentes}\n` +
                  `Promedio de Asistencia: ${promedio} personas\n\n` +
                  `üìä Pr√≥ximamente: Gr√°ficas detalladas`);
        }

        function verHistorial() {
            alert('üìã Historial completo de reportes\n\nPr√≥ximamente podr√°s:\n‚Ä¢ Filtrar por fecha\n‚Ä¢ Buscar por tipo de actividad\n‚Ä¢ Exportar reportes\n‚Ä¢ Ver tendencias
                item.innerHTML = `
                    <span class="auxiliar-nombre-asistencia">${auxiliar.icono} ${auxiliar.nombre}</span>
                    <div class="asistencia-opciones">
                        <label class="radio-option asistio">
                            <input type="radio" name="asistencia_${index}" value="asistio" checked>
                            <span>‚úÖ Asisti√≥</span>
                        </label>
                        <label class="radio-option falta">
                            <input type="radio" name="asistencia_${index}" value="falta">
                            <span>‚ùå No Asisti√≥</span>
                        </label>
                        <label class="radio-option permiso">
                            <input type="radio" name="asistencia_${index}" value="permiso">
                            <span>üìù Permiso</span>
                        </label>
                    </div>
                `;
                listaAsistencia.appendChild(item);
            });
        }

        function toggleFormularioReporte() {
            const formulario = document.getElementById('formularioReporte');
            if (formulario.style.display === 'none') {
                formulario.style.display = 'block';
                document.getElementById('fechaActividad').valueAsDate = new Date();
                calcularTotal();
            } else {
                formulario.style.display = 'none';
                document.getElementById('formReporte').reset();
            }
        }

        function guardarReporte(event) {
            event.preventDefault();

            // Recopilar datos del formulario
            const fecha = document.getElementById('fechaActividad').value;
            const tipo = document.getElementById('tipoActividad').value;
            const adultos = document.getElementById('cantidadAdultos').value;
            const ninos = document.getElementById('cantidadNinos').value;
            const total = document.getElementById('totalAsistentes').value;
            const observaciones = document.getElementById('observaciones').value;

            // Recopilar asistencia
            const asistencia = {};
            datosGrupo.auxiliares.forEach((auxiliar, index) => {
                const seleccion = document.querySelector(`input[name="asistencia_${index}"]:checked`);
                asistencia[auxiliar.nombre] = seleccion ? seleccion.value : 'asistio';
            });

            // Crear objeto de reporte
            const reporte = {
                fecha,
                tipo,
                adultos,
                ninos,
                total,
                observaciones,
                asistencia,
                grupo: datosGrupo.nombre,
                mision: datosGrupo.mision,
                lider: datosGrupo.lider,
                fechaCreacion: new Date().toISOString()
            };

            // Guardar en localStorage
            let reportes = JSON.parse(localStorage.getItem('reportes') || '[]');
            reportes.unshift(reporte);
            localStorage.setItem('reportes', JSON.stringify(reportes));

            // Mostrar confirmaci√≥n
            alert('‚úÖ Reporte guardado exitosamente!\n\nFecha: ' + fecha + '\nTipo: ' + tipo + '\nTotal Asistentes: ' + total);

            // Limpiar formulario y ocultarlo
            toggleFormularioReporte();

            // Recargar tabla
            cargarReportes();
        }

        function cargarReportes() {
            const reportes = JSON.parse(localStorage.getItem('reportes') || '[]');
            const tbody = document.getElementById('tablaReportes');
            
            // Filtrar reportes del grupo actual
            const reportesGrupo = reportes.filter(r => 
                r.grupo === datosGrupo.nombre && r.mision === datosGrupo.mision
            );

            if (reportesGrupo.length === 0) {
                tbody.innerHTML = `
                    <tr class="no-data">
                        <td colspan="7">
                            <p style="text-align: center; padding: 30px; color: #999;">
                                No hay reportes registrados a√∫n.<br>
                                <small>Haz clic en "Crear Nuevo Reporte" para comenzar.</small>
                            </p>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = '';
            reportesGrupo.slice(0, 10).forEach((reporte, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${reporte.fecha}</td>
                    <td>${reporte.tipo}</td>
                    <td>${reporte.adultos}</td>
                    <td>${reporte.ninos}</td>
                    <td><strong>${reporte.total}</strong></td>
                    <td><span class="badge-activo">Registrado</span></td>
                    <td>
                        <button class="btn-small" onclick="verDetalleReporte(${index})">üëÅÔ∏è Ver</button>
                        <button class="btn-small danger" onclick="eliminarReporte(${index})">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function verDetalleReporte(index) {
            const reportes = JSON.parse(localStorage.getItem('reportes') || '[]');
            const reportesGrupo = reportes.filter(r => 
                r.grupo === datosGrupo.nombre && r.mision === datosGrupo.mision
            );
            const reporte = reportesGrupo[index];

            let asistenciaTexto = '\n\nüìã ASISTENCIA DE AUXILIARES:\n';
            for (const [nombre, estado] of Object.entries(reporte.asistencia)) {
                const emoji = estado === 'asistio' ? '‚úÖ' : estado === 'permiso' ? 'üìù' : '‚ùå';
                asistenciaTexto += `${emoji} ${nombre}\n`;
            }

            alert(`üìä DETALLE DEL REPORTE\n\n` +
                  `Fecha: ${reporte.fecha}\n` +
                  `Tipo: ${reporte.tipo}\n` +
                  `Adultos: ${reporte.adultos}\n` +
                  `Ni√±os: ${reporte.ninos}\n` +
                  `Total: ${reporte.total}\n` +
                  `Observaciones: ${reporte.observaciones || 'Sin observaciones'}` +
                  asistenciaTexto);
        }

        function eliminarReporte(index) {
            if (!confirm('¬øEst√°s seguro de eliminar este reporte?')) return;

            const reportes = JSON.parse(localStorage.getItem('reportes') || '[]');
            const reportesGrupo = reportes.filter(r => 
                r.grupo === datosGrupo.nombre && r.mision === datosGrupo.mision
            );
            const reporteAEliminar = reportesGrupo[index];

            const todosReportes = JSON.parse(localStorage.getItem('reportes') || '[]');
            const indexGlobal = todosReportes.findIndex(r => 
                r.fechaCreacion === reporteAEliminar.fechaCreacion
            );

            if (indexGlobal > -1) {
                todosReportes.splice(indexGlobal, 1);
                localStorage.setItem('reportes', JSON.stringify(todosReportes));
                cargarReportes();
                alert('‚úÖ Reporte eliminado');
            }
        }

        // Cargar reportes al iniciar
        cargarReportes();

        // Funci√≥n para volver seg√∫n el rol
        function volverAtras() {
            if (usuario.rol === 'administrador') {
                window.location.href = 'dashboard-admin.html';
            } else {
                window.location.href = 'reportes-misiones.html';
            }
        }

        // Funciones de acciones
        function crearReporte() {
            alert('Pr√≥ximamente: Formulario para crear nuevo reporte\n\nPodr√°s registrar:\n‚Ä¢ Fecha y hora\n‚Ä¢ Tipo de actividad\n‚Ä¢ N√∫mero de asistentes\n‚Ä¢ Observaciones\n‚Ä¢ Testimonios');
        }

        function verEstadisticas() {
            alert('Pr√≥ximamente: Estad√≠sticas del ' + datosGrupo.nombre + '\n\n‚Ä¢ Gr√°ficas de asistencia\n‚Ä¢ Actividades realizadas\n‚Ä¢ Crecimiento del grupo\n‚Ä¢ Metas alcanzadas');
        }

        function verHistorial() {
            alert('Pr√≥ximamente: Historial completo de reportes\n\nPodr√°s filtrar por:\n‚Ä¢ Fecha\n‚Ä¢ Tipo de actividad\n‚Ä¢ Responsable\n‚Ä¢ Estado');
        }
    </script>
</body>
</html>
